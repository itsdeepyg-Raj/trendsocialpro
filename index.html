<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>TrendSocial Pro</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: #f4f4f5; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .aspect-3-4 { aspect-ratio: 3 / 4; }
        .glass { background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .btn-primary { background: white; color: black; font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em; transition: all 0.2s; border-radius: 1rem; }
        .btn-primary:active { transform: scale(0.95); }
        .card { background: #111; border: 1px solid #222; border-radius: 1.5rem; padding: 1.5rem; }
        input, select, textarea { background: #18181b !important; border: 1px solid #27272a !important; color: white !important; border-radius: 0.75rem; width: 100%; padding: 1rem; font-size: 14px; }
        input:focus { border-color: #6366f1 !important; outline: none; }
        .badge { font-size: 9px; font-weight: 900; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.05em; }
        .badge-admin { background: #f59e0b; color: #000; }
        .badge-reseller { background: #6366f1; color: #fff; }
        .avatar { width: 44px; height: 44px; border-radius: 14px; object-fit: cover; background: #27272a; border: 1px solid rgba(255,255,255,0.1); }
        .stat-card { background: #18181b; padding: 1rem; border-radius: 1rem; border: 1px solid #27272a; }
        .search-tag { background: #18181b; border: 1px solid #27272a; padding: 4px 12px; border-radius: 8px; font-size: 10px; font-weight: 700; color: #a1a1aa; white-space: nowrap; }
    </style>
</head>
<body class="bg-black">

    <div id="app" class="max-w-md mx-auto h-screen flex flex-col relative overflow-hidden bg-zinc-950 shadow-2xl border-x border-zinc-900">
        <div id="loading" class="flex-1 flex items-center justify-center">
            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-indigo-500"></div>
        </div>
    </div>

    <div id="recaptcha-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, signOut, signInAnonymously, 
            RecaptchaVerifier, signInWithPhoneNumber, 
            sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink 
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { 
            getFirestore, collection, doc, setDoc, getDoc, 
            addDoc, onSnapshot, query, serverTimestamp, deleteDoc, updateDoc, increment 
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // ==========================================
        // FIREBASE CONFIGURATION (LIVE)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCP7HsmoQyMeenWxhTAcgBoRs-6ErtzhJs",
            authDomain: "trend-social-88546.firebaseapp.com",
            projectId: "trend-social-88546",
            storageBucket: "trend-social-88546.firebasestorage.app",
            messagingSenderId: "859903608854",
            appId: "1:859903608854:web:82b46edf364994f7cbcd37"
        };

        const appId = 'trend-social-v12-production'; 
        const HELP_WHATSAPP = "+910000000000"; 
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State Management ---
        let currentUser = null;
        let userProfile = { role: 'buyer', currency: 'USD', photo: '' };
        let isAdmin = false;
        let isReseller = false;
        let products = [];
        let wishlist = new Set();
        let activeView = 'feed';
        let activeCategory = 'all';
        let searchQuery = "";
        let selectedProduct = null;
        let activeChatRecipient = null;
        let listenersInitialized = false;

        const rates = { USD: 1, INR: 83, EUR: 0.92 };
        const symbols = { USD: '$', INR: '₹', EUR: '€' };
        
        const LUX_CATEGORIES = [
            { id: 'all', label: 'All' },
            { id: 'beauty', label: 'Beauty' },
            { id: 'high-end', label: 'High-end Luxury' },
            { id: 'affordable', label: 'Affordable Luxury' }
        ];

        const appContainer = document.getElementById('app');

        // --- Auth & Initialization ---
        const handleEmailLinkSignIn = async () => {
            if (isSignInWithEmailLink(auth, window.location.href)) {
                let email = window.localStorage.getItem('emailForSignIn');
                if (!email) email = window.prompt('Please confirm your email:');
                try {
                    await signInWithEmailLink(auth, email, window.location.href);
                    window.localStorage.removeItem('emailForSignIn');
                } catch (error) { console.error(error); }
            }
        };

        const initAuth = async () => {
            await handleEmailLinkSignIn();
            onAuthStateChanged(auth, async (user) => {
                currentUser = user;
                if (user && !user.isAnonymous) {
                    const profileRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', user.uid);
                    const profileSnap = await getDoc(profileRef);
                    if (profileSnap.exists()) {
                        userProfile = profileSnap.data();
                    } else {
                        userProfile = { uid: user.uid, role: 'buyer', currency: 'USD', photo: '', joinedAt: new Date().toISOString() };
                        await setDoc(profileRef, userProfile);
                    }
                    const adminRef = doc(db, 'artifacts', appId, 'public', 'data', 'adminConfig', 'settings');
                    const adminSnap = await getDoc(adminRef);
                    if (!adminSnap.exists()) {
                        await setDoc(adminRef, { ownerId: user.uid });
                        isAdmin = true;
                    } else {
                        isAdmin = adminSnap.data().ownerId === user.uid;
                    }
                    isReseller = userProfile.role === 'reseller';
                    if (!listenersInitialized) {
                        initListeners();
                        listenersInitialized = true;
                    }
                } else {
                    isAdmin = false;
                    isReseller = false;
                    if (!user) signInAnonymously(auth);
                }
                render();
            });
        };

        const initListeners = () => {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (snapshot) => {
                products = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            });
            if (currentUser && !currentUser.isAnonymous) {
                onSnapshot(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'wishlist'), (snapshot) => {
                    wishlist = new Set(snapshot.docs.map(d => d.id));
                    render();
                });
            }
        };

        const formatPrice = (priceUSD) => {
            const converted = priceUSD * rates[userProfile.currency || 'USD'];
            return `${symbols[userProfile.currency || 'USD']}${converted.toLocaleString(undefined, {minimumFractionDigits: userProfile.currency === 'USD' ? 2 : 0})}`;
        };

        window.handleSearch = (val) => {
            searchQuery = val.toLowerCase();
            render();
        };

        window.setView = (view, params = null) => {
            activeView = view;
            if (params) {
                if (view === 'product') selectedProduct = params;
                if (view === 'chat') activeChatRecipient = params;
            }
            render();
        };

        window.toggleWishlist = async (productId) => {
            if (!currentUser || currentUser.isAnonymous) { setView('auth'); return; }
            const wishRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'wishlist', productId);
            const prodRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', productId);
            if (wishlist.has(productId)) {
                await deleteDoc(wishRef);
                await updateDoc(prodRef, { wishlistCount: increment(-1) });
            } else {
                await setDoc(wishRef, { addedAt: serverTimestamp() });
                await updateDoc(prodRef, { wishlistCount: increment(1) });
            }
        };

        // --- Render UI ---
        function render() {
            if (!currentUser) return;
            switch (activeView) {
                case 'feed': renderFeed(); break;
                case 'product': renderProductDetail(); break;
                case 'admin': renderAdminDashboard(); break;
                case 'reseller_hub': renderResellerDashboard(); break;
                case 'reseller_reg': renderResellerRegistration(); break;
                case 'shipping': renderShippingHub(); break;
                case 'messages': renderInbox(); break;
                case 'chat': renderChat(); break;
                case 'profile': renderBuyerDashboard(); break;
                case 'help': renderHelp(); break;
                case 'wishlist': renderWishlistView(); break;
                case 'auth': renderAuth(); break;
                default: renderFeed();
            }
            lucide.createIcons();
        }

        function renderHeader() {
            const photoUrl = userProfile.photo || `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.uid}`;
            return `
                <header class="glass sticky top-0 z-50">
                    <div class="p-4 flex justify-between items-center">
                        <div class="flex items-center gap-3" onclick="setView('profile')">
                            <img src="${photoUrl}" class="avatar" />
                            <div class="flex flex-col">
                                <h1 class="text-sm font-black tracking-tighter italic uppercase">Trend<span class="text-indigo-500">Social</span></h1>
                                <p class="text-[8px] font-black text-zinc-500 uppercase tracking-widest">${userProfile.currency || 'USD'}</p>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="setView('wishlist')" class="p-2 hover:bg-zinc-800 rounded-full text-rose-500"><i data-lucide="heart" size="20"></i></button>
                            ${isAdmin ? `<button onclick="setView('admin')" class="p-2 hover:bg-zinc-800 rounded-full text-amber-500"><i data-lucide="shield-check" size="20"></i></button>` : ''}
                            ${isReseller ? `<button onclick="setView('reseller_hub')" class="p-2 hover:bg-zinc-800 rounded-full text-indigo-500"><i data-lucide="layout-dashboard" size="20"></i></button>` : ''}
                        </div>
                    </div>
                    <div class="px-4 pb-4">
                        <div class="relative group">
                            <input id="globalSearch" type="text" placeholder="Search Paithani, Sarees, Men, Women..." value="${searchQuery}" oninput="window.handleSearch(this.value)" class="pl-10 pr-4 py-3 bg-zinc-900 border-zinc-800 rounded-xl text-xs w-full focus:ring-1 focus:ring-indigo-500 transition-all" />
                            <i data-lucide="search" class="absolute left-3 top-3.5 text-zinc-600 w-4 h-4"></i>
                        </div>
                    </div>
                </header>
            `;
        }

        function renderNav() {
            return `
                <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto border-t border-zinc-900 glass flex justify-around p-4 z-50 rounded-t-3xl shadow-2xl">
                    <button onclick="setView('feed')" class="${activeView === 'feed' ? 'text-indigo-500 scale-125' : 'text-zinc-500'}"><i data-lucide="shopping-bag"></i></button>
                    <button onclick="setView('messages')" class="${activeView === 'messages' ? 'text-indigo-500 scale-125' : 'text-zinc-500'}"><i data-lucide="message-circle"></i></button>
                    <button onclick="setView('profile')" class="${activeView === 'profile' ? 'text-indigo-500 scale-125' : 'text-zinc-500'}"><i data-lucide="user"></i></button>
                </nav>
            `;
        }

        function renderFeed() {
            let filtered = activeCategory === 'all' ? products : products.filter(p => p.category === activeCategory);
            if (searchQuery) {
                filtered = filtered.filter(p => p.title.toLowerCase().includes(searchQuery) || p.description.toLowerCase().includes(searchQuery));
            }

            let html = renderHeader() + `
                <div class="flex gap-2 px-4 py-4 overflow-x-auto no-scrollbar bg-black border-b border-zinc-900">
                    ${LUX_CATEGORIES.map(cat => `
                        <button onclick="window.activeCategory='${cat.id}'; render()" class="px-5 py-2 rounded-full text-[10px] font-black uppercase tracking-widest border transition-all ${activeCategory === cat.id ? 'bg-white text-black border-white shadow-lg' : 'border-zinc-800 text-zinc-500'}">${cat.label}</button>
                    `).join('')}
                </div>
                <main class="flex-1 overflow-y-auto pb-24 no-scrollbar">
                    <div class="grid grid-cols-2 gap-px bg-zinc-900">
            `;
            filtered.forEach(p => {
                const isLiked = wishlist.has(p.id);
                html += `
                    <div class="bg-zinc-950 aspect-3-4 relative cursor-pointer overflow-hidden border-b border-zinc-900" onclick='setView("product", ${JSON.stringify(p).replace(/'/g, "&apos;")})'>
                        ${getMediaHTML(p.mediaUrl, 'w-full h-full object-cover')}
                        <button onclick="event.stopPropagation(); toggleWishlist('${p.id}')" class="absolute top-3 right-3 p-2 bg-black/40 backdrop-blur-md rounded-full z-10"><i data-lucide="heart" class="w-4 h-4 ${isLiked ? 'fill-rose-500 text-rose-500' : 'text-white'}"></i></button>
                        <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/90 via-black/40 to-transparent">
                            <p class="font-bold text-[10px] truncate uppercase tracking-tight">${p.title}</p>
                            <p class="text-indigo-500 font-black text-[10px] mt-0.5">${formatPrice(p.price)}</p>
                        </div>
                    </div>
                `;
            });
            html += '</div></main>' + renderNav();
            appContainer.innerHTML = html;
        }

        function renderAdminDashboard() {
            appContainer.innerHTML = renderHeader() + `
                <div class="p-6 space-y-8 flex-1 overflow-y-auto no-scrollbar pb-32">
                    <h2 class="text-xl font-black uppercase text-amber-500">Admin Control</h2>
                    <div id="requestList" class="space-y-3"></div>
                </div>
            ` + renderNav();
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'), (snapshot) => {
                const list = document.getElementById('requestList');
                if (!list) return;
                const pending = snapshot.docs.map(d => ({id: d.id, ...d.data()})).filter(p => p.role === 'reseller_pending');
                list.innerHTML = pending.length ? pending.map(r => `
                    <div class="card space-y-4">
                        <p class="font-black text-sm uppercase">${r.shopName}</p>
                        <p class="text-[9px] text-zinc-500">PAN: ${r.pan} | BANK: ${r.acc}</p>
                        <div class="flex gap-2">
                            <button onclick="handleVerifyUser('${r.id}', 'reseller')" class="flex-1 bg-green-600 py-3 rounded-xl font-black text-[9px] uppercase">Approve</button>
                            <button onclick="handleVerifyUser('${r.id}', 'buyer')" class="flex-1 bg-red-600/10 text-red-500 py-3 rounded-xl font-black text-[9px] uppercase">Reject</button>
                        </div>
                    </div>`).join('') : `<p class="py-10 text-center text-zinc-800 text-xs">No pending requests</p>`;
            });
        }

        window.handleVerifyUser = async (uid, role) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', uid), { role });
            alert(`Member updated to ${role}`);
        };

        function renderResellerDashboard() {
            appContainer.innerHTML = renderHeader() + `
                <div class="p-6 space-y-8 flex-1 overflow-y-auto no-scrollbar pb-32">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-black uppercase italic tracking-tighter">Reseller Hub</h2>
                        <button onclick="setView('shipping')" class="bg-indigo-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest">Logistics Hub</button>
                    </div>
                    <form id="productForm" class="card space-y-4">
                        <input id="mediaUrl" placeholder="Media URL (Instagram/Image)" required />
                        <select id="pCat">
                            <option value="beauty">Beauty</option>
                            <option value="high-end">High-end Luxury</option>
                            <option value="affordable">Affordable Luxury</option>
                        </select>
                        <input id="price" type="number" placeholder="Price (USD)" required />
                        <input id="title" placeholder="Item Name (e.g. Silk Saree)" required />
                        <textarea id="desc" placeholder="Details (Add tags like #women #men)..." required></textarea>
                        <button type="submit" class="w-full btn-primary py-4 rounded-2xl">Publish Listing</button>
                    </form>
                </div>` + renderNav();
            document.getElementById('productForm').onsubmit = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), {
                    title: document.getElementById('title').value,
                    price: parseFloat(document.getElementById('price').value),
                    description: document.getElementById('desc').value,
                    category: document.getElementById('pCat').value,
                    whatsapp: userProfile.whatsapp,
                    shopName: userProfile.shopName,
                    mediaUrl: document.getElementById('mediaUrl').value,
                    vendorId: currentUser.uid,
                    wishlistCount: 0,
                    createdAt: serverTimestamp()
                });
                setView('feed');
            };
        }

        function renderBuyerDashboard() {
            const photoUrl = userProfile.photo || `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.uid}`;
            appContainer.innerHTML = `
                <div class="p-8 space-y-10 flex-1 overflow-y-auto no-scrollbar pb-32">
                    <div class="text-center space-y-4">
                        <img src="${photoUrl}" class="w-24 h-24 rounded-[32px] mx-auto shadow-2xl" />
                        <h2 class="text-2xl font-black uppercase tracking-tighter">${currentUser.email || 'Global Buyer'}</h2>
                    </div>
                    <div class="card space-y-4">
                        <p class="text-[9px] font-bold text-zinc-600 uppercase">Currency Preference</p>
                        <select onchange="window.updateProfile({currency: this.value})">
                            <option value="USD" ${userProfile.currency === 'USD' ? 'selected' : ''}>USD ($)</option>
                            <option value="INR" ${userProfile.currency === 'INR' ? 'selected' : ''}>INR (₹)</option>
                            <option value="EUR" ${userProfile.currency === 'EUR' ? 'selected' : ''}>EUR (€)</option>
                        </select>
                    </div>
                    <div class="space-y-3">
                        ${!isReseller && userProfile.role === 'buyer' && !isAdmin ? `<button onclick="setView('reseller_reg')" class="w-full bg-indigo-600 py-5 rounded-3xl font-black uppercase text-xs">Join Indian Reseller Program</button>` : ''}
                        <button onclick="signOut(auth)" class="w-full p-5 text-red-500 font-black uppercase text-xs">Sign Out</button>
                    </div>
                </div>` + renderNav();
            window.updateProfile = async (data) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', currentUser.uid), data);
                userProfile = { ...userProfile, ...data };
                render();
            };
        }

        function getMediaHTML(url, className) {
            if (!url) return `<div class="${className} bg-zinc-900 flex items-center justify-center"><i data-lucide="image" class="opacity-10"></i></div>`;
            const isVideo = url.match(/\.(mp4|webm|ogg|mov)$/i) || url.includes('video');
            if (isVideo) return `<video src="${url}" class="${className}" muted autoplay loop playsinline></video>`;
            return `<img src="${url}" class="${className}" onerror="this.src='https://via.placeholder.com/400x500?text=Invalid+Media'">`;
        }

        function renderAuth() {
            appContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full p-8 space-y-12 bg-black">
                    <h1 class="text-5xl font-black italic tracking-tighter uppercase italic">Trend<span class="text-indigo-500 font-black">Social</span></h1>
                    <form id="authForm" class="w-full space-y-4">
                        <input id="email" type="email" placeholder="Email Address" required />
                        <button type="submit" class="w-full btn-primary py-5 rounded-3xl">Get Login Link</button>
                    </form>
                    <button onclick="setView('feed')" class="text-zinc-700 text-[10px] font-black uppercase">Browse as Guest</button>
                </div>
            `;
            document.getElementById('authForm').onsubmit = async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                await sendSignInLinkToEmail(auth, email, { url: window.location.href, handleCodeInApp: true });
                window.localStorage.setItem('emailForSignIn', email);
                alert("Check your email for the magic link!");
            };
        }

        initAuth();
    </script>
</body>
</html>
